<!-- markdownlint-disable MD013 MD034 MD033 MD038 MD051 -->

# References

All APIs listed in this doc are recommended for customizing or implementing your own searching commands.

They are supposed to be stable and tested.

## Table of contents

- [Line-Oriented Helpers](#line-oriented-helpers)
  - [fzfx.helper.actions](#fzfxhelperactions)
    - [`FzfxFiles`/`FzfxBuffers`/`FzfxGFiles`](#fzfxfilesfzfxbuffersfzfxgfiles)
    - [`FzfxLiveGrep`/`FzfxGLiveGrep`](#fzfxlivegrepfzfxglivegrep)
- [Fundamental Infrastructures](#fundamental-infrastructures)
  - [fzfx.lib.colors](#fzfxlibcolors)
  - [fzfx.lib.commands](#fzfxlibcommands)
  - [fzfx.lib.constants](#fzfxlibconstants)
  - [fzfx.lib.deprecations](#fzfxlibdeprecations)
  - [fzfx.lib.env](#fzfxlibenv)
  - [fzfx.lib.filesystems](#fzfxlibfilesystems)
  - [fzfx.lib.jsons](#fzfxlibjsons)
  - [fzfx.lib.numbers](#fzfxlibnumbers)
  - [fzfx.lib.nvims](#fzfxlibnvims)
  - [fzfx.lib.paths](#fzfxlibpaths)
  - [fzfx.lib.spawn](#fzfxlibspawn)
  - [fzfx.lib.strings](#fzfxlibstrings)
  - [fzfx.lib.tables](#fzfxlibtables)
- [Logger](#logger)
  - [fzfx.log](#fzfxlog)

## [Line-Oriented Helpers](/lua/fzfx/helper)

The `fzfx.helper` provides line-oriented helpers for parsing and rendering queries/lines required in all scenarios.

### [fzfx.helper.actions](/lua/fzfx/helper/actions.lua)

- `nop():nil`: do nothing.

#### `FzfxFiles`/`FzfxBuffers`/`FzfxGFiles`

> The lines are file names generated by `fd`/`find`/`git ls-files` or other sources (buffers) follow the same style, they look like:
>
> ```
>  README.md
> 󰢱 lua/fzfx.lua/test/hello world.txt
> ```

- `edit_find(lines:string[], context:fzfx.PipelineContext):nil`: use `edit` command to open selected files on `fd`/`find`/`git ls-files` results.
- `setqflist_find(lines:string[], context:fzfx.PipelineContext):nil`: use `setqflist` command to send selected lines (files) to qflist.

#### `FzfxLiveGrep`/`FzfxGLiveGrep`

> The lines are locations (file name with line/column number) generated by `rg`/`grep`/`git grep` or other sources (lsp, diagnostics) follow the same style, they look like:
>
> ```
> 󰢱 lua/fzfx.lua:15:82: local strs = require("fzfx.lib.strings")
> 󰢱 lua/fzfx/config.lua:1:70: local line = parsers.parse_find(lines, context)
> ```
>
> Note: the `rg` (lsp, diagnostics) have column number, while `grep`/`git grep` don't have column number.

- `edit_rg(lines:string[], context:fzfx.PipelineContext):nil`: use `edit` and `setpos` command to open selected locations on `rg` results.
- `setqflist_rg(lines:string[], context:fzfx.PipelineContext):nil`: use `setqflist` command to send selected locations to qflist.
- `edit_grep(lines:string[], context:fzfx.PipelineContext):nil`: use `edit` and `setpos` command to open selected locations on `grep`/`git grep` results.
- `setqflist_grep(lines:string[], context:fzfx.PipelineContext):nil`: use `setqflist` command to send selected locations to qflist.

#### `FzfxGStatus`/`FzfxGBlame`

> The lines are git status (changed file names) generated by `git status`, they look like:
>
> ```
>  D fzfx/constants.lua
>  M fzfx/line_helpers.lua
>  M ../test/line_helpers_spec.lua
> ?? ../hello
> ```

- `edit_git_status(lines:string[]):nil`: use `edit` command to open selected file names on `git status` results.

#### `FzfxGBranches`

> The lines are git branches generated by `git branch`, they look like:
>
> ```
> * chore-lint
>   main
>   remotes/origin/HEAD -> origin/main
>   remotes/origin/chore-lint
>   remotes/origin/main
> ```

- `git_checkout(lines:string[], fzfx.GitBranchesPipelineContext):nil`: use `git checkout` shell command to checkout selected branch on `git branch` results.

#### `FzfxGCommits`/`FzfxGBlame`

> The lines are git branches generated by `git log`/`git blame`, they look like:
>
> ```
> c2e32c 2023-11-30 linrongbin16 (HEAD -> chore-lint)
> 5fe6ad 2023-11-29 linrongbin16 chore
> ```

- `yank_git_commit(lines:string[]):nil`: yank selected git commits on `git log`/`git blame` results.

#### `FzfxCommands`

> The lines are vim commands generated by builtin renderer, they look like:
>
> ```
> Name              Bang|Bar|Nargs|Range|Complete         Desc/Location
> :!                N   |Y  |N/A  |N/A  |N/A              /opt/homebrew/Cellar/neovim/0.9.4/share/nvim/runtime/doc/index.txt:1122
> :Next             N   |Y  |N/A  |N/A  |N/A              /opt/homebrew/Cellar/neovim/0.9.4/share/nvim/runtime/doc/index.txt:1124
> :bdelete          N   |Y  |N/A  |N/A  |N/A              "delete buffer"
> ```
   
- `feed_vim_command(lines:string[], context:fzfx.VimCommandsPipelineContext):nil`: input selected command in vim command line.

#### `FzfxKeyMaps`

> The lines are vim key mappings generated by builtin renderer, they look like:
>
> ```
> Lhs                                          Mode|Noremap|Nowait|Silent Rhs/Location
> <C-F>                                            |N      |N     |N      ~/.config/nvim/lazy/nvim-cmp/lua/cmp/utils/keymap.lua:127
> <CR>                                             |N      |N     |N      ~/.config/nvim/lazy/nvim-cmp/lua/cmp/utils/keymap.lua:127
> <Plug>(YankyGPutAfterShiftRight)             n   |Y      |N     |Y      ~/.config/nvim/lazy/yanky.nvim/lua/yanky.lua:369
> %                                            n   |N      |N     |Y      "<Plug>(matchup-%)"
> &                                            n   |Y      |N     |N      ":&&<CR>"
> <2-LeftMouse>                                n   |N      |N     |Y      "<Plug>(matchup-double-click)"
> ```
   
- `feed_vim_key(lines:string[], context:fzfx.VimKeyMapsPipelineContext):nil`: execute selected keys.

#### `FzfxFileExplorer`

> The lines are file names or directories generated by `lsd`/`eza`/`ls`, they look like:
>
> ```
> -rw-r--r--   1 linrongbin  staff   1.0K Aug 28 12:39 LICENSE
> -rw-r--r--   1 linrongbin  staff    27K Oct  8 11:37 README.md
> drwxr-xr-x   3 linrongbin  staff    96B Aug 28 12:39 autoload
> drwxr-xr-x   4 linrongbin  staff   128B Sep 22 10:11 bin
> -rw-r--r--   1 linrongbin  staff   120B Sep  5 14:14 codecov.yml
> ```

- `edit_ls(lines:string[], context:fzfx.FileExplorerPipelineContext):nil`: use `edit` command to open selected file path on `lsd`/`eza`/`ls` results.

### [fzfx.helper.parsers](/lua/fzfx/helper/parsers.lua)

### [fzfx.helper.prompts](/lua/fzfx/helper/prompts.lua)

### [fzfx.helper.queries](/lua/fzfx/helper/queries.lua)

## [Fundamental Infrastructures](/lua/fzfx/lib)

The `fzfx.lib` provides fundamental infrastructures for whole plugin, they're usually handling below issues:

- Cross platforms compatibility between Windows and Linux/macOS.
- Neovim APIs compatibility between v0.7-nightly versions.
- Files IO & paths.
- Json and lua table conversion.
- Some constants, strings, numbers, lua table and list data structures.
- Environment variables.
- Command line running, e.g. child process.

### [fzfx.lib.colors](/lua/fzfx/lib/colors.lua)

- `csi(code:string, fg:boolean):string`: convert ansi color codes (`38`, `42`) or rgb/css color codes (`#FF3810`) into terminal escaped sequences (`\x1b[38m`, `\x1b[0m`). set `fg=true` for foreground, set `fg=false` for background.
  - for ansi color codes, please see: https://gist.github.com/fnky/458719343aabd01cfb17a3a4f7296797#color-codes
  - for rgb/css color codes, please see: https://www.w3schools.com/tags/ref_colornames.asp
- `hlcode(attr:"fg"|"bg", hl:string):string?`: retrieve ansi color codes or rgb/css color codes from vim syntax highlighting group (e.g. `Special`, `Constants`, `Number`).
- `ansi(text:string, name:string, hl:string?):string?`: render `text` with specified color name `name` (e.g. `red`, `green`, `magenta`), if use vim syntax highlighting if `hl` is provided.
- `erase(text:string):string`: erase colors from terminal escaped contents.

builtin colors

- `black(text:string, hl:string?):string`: render `text` with `black`, use vim syntax highlighting if `hl` provided
- `grey(text:string, hl:string?):string`: same.
- `silver(text:string, hl:string?):string`: same.
- `white(text:string, hl:string?):string`: same.
- `violet(text:string, hl:string?):string`: same.
- `magenta(text:string, hl:string?):string`: same, or `fuchsia`.
- `red(text:string, hl:string?):string`: same.
- `purple(text:string, hl:string?):string`: same.
- `indigo(text:string, hl:string?):string`: same.
- `yellow(text:string, hl:string?):string`: same.
- `gold(text:string, hl:string?):string`: same.
- `orange(text:string, hl:string?):string`: same.
- `chocolate(text:string, hl:string?):string`: same.
- `olive(text:string, hl:string?):string`: same.
- `green(text:string, hl:string?):string`: same.
- `lime(text:string, hl:string?):string`: same.
- `teal(text:string, hl:string?):string`: same.
- `cyan(text:string, hl:string?):string`: same, or `aqua`.
- `blue(text:string, hl:string?):string`: same.
- `navy(text:string, hl:string?):string`: same.
- `slateblue(text:string, hl:string?):string`: same.
- `steelblue(text:string, hl:string?):string`: same.

- `render(renderer:fun(text:string, hl:string?):string, hl:string?, fmt:string, ...:any):string`: render parameters `...` with `renderer` and optional `hl`, and format with `fmt`.

### [fzfx.lib.commands](/lua/fzfx/lib/commands.lua)

- `CommandResult`: command line result

  - fields:
    - `stdout:string[]|nil`: stdout lines.
    - `stderr:string[]|nil`: stderr lines.
    - `code:integer?`: exit code.
    - `signal:integer?`: signal.
  - `failed():boolean`: exit code `code ~= 0` and `stderr` not empty.

- `Command`: command line (blocking mode spawn).

  - `run(cmds:string[]):Command`: run command line, return handle.
  - `failed():boolean`: same with `CommandResult`, use `Command.result` to get command line result.

- `GitRootCommand`

  - `run():GitRootCommand`: run `git rev-parse --show-toplevel`, return handle.
  - `failed():boolean`: same with `Command`, use `GitRootCommand.result` to get command line result.
  - `output():string?`: get the command output.

- `GitBranchesCommand`

  - `run(remotes:boolean?):GitBranchesCommand`: run `git branch` or `git branch --remotes`, return handle.
  - `failed():boolean`: same with `Command`, use `GitBranchesCommand.result` to get command line result.
  - `output():string[]|nil`: get the command output.

- `GitCurrentBranchCommand`
  - `run():GitCurrentBranchCommand`: run `git rev-parse --abbrev-ref HEAD`, return handle.
  - `failed():boolean`: same with `Command`, use `GitCurrentBranchCommand.result` to get command line result.
  - `output():string?`: get the command output.

### [fzfx.lib.constants](/lua/fzfx/lib/constants.lua)

#### OS

- `IS_WINDOWS`: is Windows.
- `IS_MACOS`: is macOS.
- `IS_BSD`: is BSD.
- `IS_LINUX`: is UNIX or Linux.

#### Command Line

bat/cat

- `HAS_BAT`: has `bat` command.
- `BAT`: `bat` command.
- `HAS_CAT`: has `cat` command.
- `CAT`: `cat` command.

rg/grep

- `HAS_RG`: has `rg` command.
- `RG`: `rg` command.
- `HAS_GNU_GREP`: has gnu `grep`/`ggrep` command.
- `GNU_GREP`: `grep`/`ggrep` command.
- `HAS_GREP`: has `grep`/`ggrep` command.
- `GREP`: `grep`/`ggrep` command.

fd/find

- `HAS_FD`: has `fd` command.
- `FD`: `fd` command.
- `HAS_FIND`: has `find`/`gfind` command.
- `FIND`: `find`/`gfind` command.

ls/lsd/eza

- `HAS_LS`: has `ls` command.
- `LS`: `ls` command.
- `HAS_LSD`: has `lsd` command.
- `LSD`: `lsd` command.
- `HAS_EZA`: has `eza`/`exa` command.
- `EZA`: `eza`/`exa` command.

git/delta

- `HAS_GIT`: has `git` command.
- `GIT`: `git` command.
- `HAS_DELTA`: has `delta` command.
- `DELTA`: `delta` command.

echo

- `HAS_ECHO`: has `echo` command.
- `ECHO`: `echo` command.

curl

- `HAS_CURL`: has `curl` command.
- `CURL`: `curl` command.

### [fzfx.lib.deprecations](/lua/fzfx/lib/deprecations.lua)

- `notify(fmt:string, ...:any):nil`: print deprecation notifications to command line.

### [fzfx.lib.env](/lua/fzfx/lib/env.lua)

- `debug_enabled():boolean`: detect whether environment variable `_FZFX_NVIM_DEBUG_ENABLE=1`.
- `icon_enabled():boolean`: detect whether environment variable `_FZFX_NVIM_DEVICONS_PATH=1`.

### [fzfx.lib.filesystems](/lua/fzfx/lib/filesystems.lua)

#### Read File

- `FileLineReader`: file line reader.
  - `open(filename:string, batchsize:integer?):FileLineReader`: open file to read, return the reader handle, by default `batchsize=4096`.
  - `has_next():boolean`: detect whether there are more lines to read.
  - `next():string?`: get next line.
  - `close():nil`: close the reader handle.
- `readlines(filename:string):string[]|nil`: open file and read line by line.
- `readfile(filename:string, opts:{trim:boolean?}?):string?`: open and read all contents from file.
  - set `opts={trim=true}` to trim whitespaces, by default `opts={trim=true}`.
- `asyncreadfile(filename:string, on_complete:fun(data:string?):any, opts:{trim:boolean?}?):nil`: async read file, invoke callback `on_complete` when done.

#### Write File

- `writefile(filename:string, content:string):integer`: write content into file, return `-1` if fail, `0` if success.
- `writelines(filename:string, lines:string[]):integer`: write lines into file, return `-1` if fail, `0` if success.
- `asyncwritefile(filename:string, content:string, on_complete:fun(bytes:integer?):any):integer`: async write content into a file, invoke callback `on_complete` when done.

### [fzfx.lib.jsons](#/lua/fzfx/lib/jsons.lua)

- `encode(t:table?):string?`: convert lua table/list to json string.
- `decode(s:string?):table?`: convert json string to lua table/list.

### [fzfx.lib.numbers](/lua/fzfx/lib/numbers.lua)

- `INT32_MIN`/`INT32_MAX`: `-2147483648`/`2147483647`.
- `positive(n:number?):boolean`/`negative(n:number?):boolean`: is positive/negative number, e.g. `n > 0`/`n < 0`.
- `non_positive(n:number?):boolean`/`non_negative(n:number?):boolean`: is non-positive/non-negative number, e.g. `n <= 0`/`n >= 0`.
- `bound(value:integer, left:integer, right:integer):integer`: returned value is bounded in range `[left, right]`.
- `inc_id():integer`: returned incremental ID.

### [fzfx.lib.nvims](/lua/fzfx/lib/nvims.lua)

#### Buffer

- `get_buf_option(bufnr:integer, name:string):any`: get buffer option.
- `set_buf_option(bufnr:integer, name:string, value:any):nil`: set buffer option.
- `buf_is_valid(bufnr:integer):boolean`: check if buffer is valid.

#### Window

- `get_win_option(winnr:integer, name:string):any`: get window option.
- `set_win_option(winnr:integer, name:string, value:any):nil`: set window option.
- `WindowOptsContext`: window options context.
  - `save():WindowOptsContext`: save current windows & tabs and return context.
  - `restore():nil`: restore previously saved windows & tabs.

#### Shell

- `shellescape(s:string, special:string?):string`: escape shell strings, especially single(`''`)/double(`""`) quotes.
- `ShellOptsContext`: shell options context.
  - `save():ShellOptsContext`: save current shell options and return context.
  - `restore():nil`: restore previously saved shell options.

### [fzfx.lib.paths](/lua/fzfx/lib/paths.lua)

- `SEPARATOR`: `\\` for Windows, `/` for Unix/Linux.
- `normalize(p:string, opts:{backslash:boolean?,expand:boolean?}?)`: normalize path string, replace `\\\\` to `\\`.
  - set `opts.backslash=true` to replace `\\` to `/`, set `opts.expand=true` to expand path to full path, by default `opts={backslash=false, expand=false}`.
- `join(...):string`: join multiple parts into path string with `SEPARATOR`.
- `reduce2home(p:string):string`: reduce path string relative to `$HOME` directory.
- `reduce(p:string):string`: reduce path string relative to `$HOME` directory or `$PWD` directory.
- `shorten(p:string):string`: shorten path string to use single char to replace each level directories, e.g. `~/g/l/fzfx.nvim`.

### [fzfx.lib.spawn](/lua/fzfx/lib/spawn.lua)

- `Spawn`: run child process and process stdout/stderr line by line.
  - `make(cmds:string[], opts:{on_stdout:fun(line:string):any, on_stderr:fun(line:string):any|nil, blocking:boolean}):Spawn`: prepare child process, return `Spawn` handle.
    - `on_stdout(line:string):any`: invoke callback when there's a new line ready to process on `stdout` fd.
    - `on_stderr(line:string):any`: invoke callback when there's a new line ready to process on `stderr` fd.
    - `blocking`: set `blocking=true` if need to wait for child process finish, set `blocking=false` if no need to wait.
  - `run():nil`: run child process, wait child process done for blocking mode, use `Spawn.result` to get the child process result.

### [fzfx.lib.strings](/lua/fzfx/lib/strings.lua)

- `empty(s:string?):boolean`/`not_empty(s:string?):boolean`: detect whether a string is empty or not.
- `blank(s:string?):boolean`/`not_blank(s:string?):boolean`: detect whether a string is blank or not.
- `find(s:string, t:string, start:integer?):integer?`: find first `t` in `s` start from `start`, by default `start=1`.
- `rfind(s:string, t:string, rstart:integer?):integer?`: reversely find last `t` in `s` start from `rstart`, by default `rstart=#s`.
- `ltrim(s:string, t:string):string`/`rtrim(s:string, t:string):string`: trim left/right `t` from `s`, by default `t` is whitespaces (`\n\t\r `).
- `split(s:string, delimiter:string, opts:{plain:boolean?,trimempty:boolean?}?):string`: split `s` by `delimiter`.
  - set `opts.plain=false` to use lua pattern matching, set `opts.trimempty=false` to not remove whitespaces from results. by default `opts={plain=true, trimempty=true}`.
- `startswith(s:string, t:string):boolean`/`endswith(s:string, t:string):boolean`: detect whether `s` is start/end with `t`.
- `isspace(c:string):boolean`: detect whether character `c` is whitespace (`\n\t\r `), `c` length must be 1.
- `isalnum(c:string):boolean`: detect whether character `c` is letter or number (`a-zA-Z0-9`), `c` length must be 1.
- `isdigit(c:string):boolean`: detect whether character `c` is number (`0-9`), `c` length must be 1.
- `ishex(c:string):boolean`: detect whether character `c` is hex number (`a-eA-E0-9`), `c` length must be 1.
- `isalpha(c:string):boolean`: detect whether character `c` is letter (`a-zA-Z`), `c` length must be 1.
- `islower(c:string):boolean`/`isupper(c:string):boolean`: detect whether character `c` is lower letter (`a-z`) or upper letter (`A-Z`), `c` length must be 1.
- `uuid(delimiter:string?):string`: make uuid, by default `delimiter='-'`.

### [fzfx.lib.tables](/lua/fzfx/lib/tables.lua)

#### Table

- `tbl_empty(t:any):boolean`/`tbl_not_empty(t:any):boolean`: detect whether a table is empty or not.

#### List

- `list_empty(l:any):boolean`/`list_not_empty(l:any):boolean`: detect whether a list(table) is empty or not.
- `list_index(i:integer, n:integer):integer`: calculate list index for both positive or negative. `n` is the length of list.
  - if `i > 0`, `i` is in range `[1,n]`.
  - if `i < 0`, `i` is in range `[-1,-n]`, `-1` maps to last position (e.g. `n`), `-n` maps to first position (e.g. `1`).

## Logger

### [fzfx.log](/lua/fzfx/log.lua)

- `debug(fmt:string, ...)`: debug, the `fmt` is formatting messages in C style formatters, e.g. `%d`, `%s`.
- `info(fmt:string, ...)`: info.
- `warn(fmt:string, ...)`: warning.
- `err(fmt:string, ...)`: error
- `echo(level:LogLevels, fmt:string, ...)`: echo message in log `level`. this API will not been affected by log configs.
  - `LogLevels.DEBUG`.
  - `LogLevels.INFO`.
  - `LogLevels.WARN`.
  - `LogLevels.ERROR`.
- `throw(fmt:string, ...)`: same with `err`, additionally it invokes `error()` API, which throw an error to user command line, requires user to press `ENTER` to continue.
- `ensure(condition:boolean, fmt:string, ...)`: throw error to user if `condition` is false.
